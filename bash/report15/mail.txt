# ★UTF-8

From: Koichi Murase <address@hidden>
To: bug-bash@gnu.org
Subject: Exit status by no-argument `return' for function calls in trap handlers

Configuration Information [Automatically generated, do not change]:
Machine: x86_64
OS: linux-gnu
Compiler: gcc
Compilation CFLAGS: -O2 -g -pipe -Wall -Werror=format-security
  -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions
  -fstack-protector-strong -grecord-gcc-switches
  -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1
  -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic
  -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection
  -Wno-parentheses -Wno-format-security
uname output: Linux chatoyancy 5.1.20-300.fc30.x86_64 #1 SMP Fri Jul
  26 15:03:11 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
Machine Type: x86_64-redhat-linux-gnu

Bash Version: 5.0
Patch Level: 11
Release Status: release

Summary:

  The behavior of no-argument `return' in trap handlers has been
  changed from Bash 4.4 to follow the description of POSIX.  Recently
  this behavior caused problems in my Bash script.  I am wondering
  whether this change actually matches with the behavior meant by
  POSIX because the change introduces unreasonable constraints in
  writing shell functions.

  For the condition of this special treatment of `return', POSIX says
  ``When return is executed in a trap action''.  Here are two possible
  interpretation: (A) `return's specified in the argument string of
  `trap' builtin are affected, or (B) all the `return's in entire
  runtime function-call tree in trap processing are affected.  I guess
  that POSIX wanted to provide a way to exit functions that received
  signals without changing the value of `$?'.  If that is the case,
  the POSIX should have meant (A).  However, the current Bash
  implementation behaves as if it follows the interpretation (B).

  I would like to hear what do you think of this.

Description:

  In the latest release of Bash 5.0.16 and in the current devel
  branch, when function calls in trap handlers are terminated by
  no-argument `return' builtin, the exit status is always the value of
  $? at the moment that the trap handler started.  This behavior was
  introduced in Bash 4.4.

  I noticed this behavior in debugging an infinite loop caused by
  SIGWINCH reported at https://github.com/akinomyoga/ble.sh/issues/48.
  The structure of the code related to the infinite loop can be
  summarized in the following small script.

  ----------------------------------------
  #!/bin/bash

  function check_loop_condition {
    if ((index++%10==0)); then
      echo index=$index
      ((index<100))
      return # *** return exit status of the previous command ***
    fi

    : do something
    return 0
  }

  function update {
    local index=0
    while check_loop_condition; do :; done
  }

  trap 'update' USR1
  kill -USR1 $$
  ----------------------------------------

  If the function `update' is called normally (outside of trap
  handlers), it will print the numbers {1..101..10} and terminate
  soon.  However, when it is called in trap handlers, it falls into an
  infinite loop in Bash 4.4+.  This is because the no-argument
  `return' in the function `check_loop_condition' always returns `$?'
  before the trap started regardless of the exit status of
  `((index<100))'.

  If all the `return's in the entire function-call tree are affected
  in trap processing as in the interpretation (B), one cannot reliably
  use no-argument `return' to return the last-command exit status.  To
  avoid the problem, one has to always write the exit status
  explicitly as `return $?', and there is no use case for no-argument
  `return' at all.  I don't think this is meant by POSIX which defines
  the behavior of no-argument `return' explicitly.  Or, maybe one
  cannot use shell functions in trap handlers.  Note that in my
  script, I need to re-render the terminal contents on SIGWINCH so
  that I need to run complicated shell programs implemented as shell
  functions.  POSIX does not prohibit the use of shell functions in
  trap handlers.

  Here I checked how the behavior was changed in Bash 4.4.  The
  related commits are 939d190e0 (commit bash-20140314 snapshot) and
  e2f12fdf5 (commit bash-20140321 snapshot).  The relevant ChangeLog
  is quoted as follows:

  >            3/11
  >            ----
  > 
  > builtins/common.c
  >   - get_exitstat: when running `return' in a trap action, and it is not
  >     supplied an argument, use the saved exit status in
  >     trap_saved_exit_value.  Fixes Posix problem reported by
  >     Eduardo A. Bustamante L坦pez <address@hidden>
  > 
  > 
  >            3/18
  >            ----
  > 
  > builtins/common.c
  >   - get_exitstat: update fix of 3/11 to allow the DEBUG trap to use the
  >     current value of $? instead of the value it had before the trap
  >     action was run.  This is one reason the DEBUG trap exists, and
  >     extended debug mode uses it.  Might want to do this only in Posix
  >     mode

  This change is made after the following discussion:

  https://lists.gnu.org/archive/html/bug-bash/2014-03/msg00053.html

  Taking the following comment and the code example by the original
  reporter Eduardo, he seems to assume the interpretation (A), but
  what was actually implemented was the interpretation (B).

  > So as I read it, `action' refers to the whole string.

  Also, I have checked the behavior of other shells. `zsh', `ash'
  family (dash/ash, busybox sh) and `posh' does not implement the
  special treatment of `return' in trap handlers.  `ksh' family
  (ksh93, mksh) and `yash' implements the interpretation (B).  There
  is no existing implementation of (A).  But currently I still think
  the intepretation (A) is reasonable.  If there is rationale for the
  interpretation (B), I would like to know it.

Repeat-By:

  Here I provide a few test cases for the special treatment of
  no-argument `return'.  The following example demonstrates the
  behavior of no-argument `return' appearing directly in the trap
  argument.  The expected result is `exit=0' but not `exit=222' as
  `return' should return the exit status before the trap handler
  starts as required by POSIX.  Bash 4.3 and before outputs `exit=222'
  because it does not implement the special treatment.  Bash 4.4 and
  later ourputs `exit=0' as expected.

  ----------------------------------------
  #!/bin/bash

  setexit() { return "$1"; }
  trap 'setexit 222; return' USR1

  process() { kill -USR1 $$; }
  process
  echo exit=$?
  ----------------------------------------

  The next example also demonstrates the behavior of no-argument
  `return' directly specified in the trap argument.  The expected
  result is to print `exit=0'.  Bash 4.3 and earlier outputs
  `exit=123', and Bash 4.4 and later outputs `exit=0' as expected by
  POSIX.

  ----------------------------------------
  #!/bin/bash

  function setexit { return "$1"; }

  trap 'setexit 123; return' USR1

  function loop { while :; do :; done; }

  function get_loop_exit { loop; echo "exit=$?"; }

  { sleep 1; kill -USR1 $$; } &
  get_loop_exit
  ----------------------------------------

  The third example is the case for `return' in function calls in trap
  processing.  If we adopt the interpretation A (B), the expected
  result is `A' (`B').  Bash 4.3 and earlier outputs `A', and Bash 4.4
  and later outputs `B'.

  ----------------------------------------
  #!/bin/bash

  check() { false; return; }
  handle() { check && echo B || echo A; }
  trap handle USR1
  kill -USR1 $$
  ----------------------------------------

Fix:

  I attach a patch which changes the behavior to match with the more
  reasonable interpretation (A).  To detect the current nest level of
  returns, I initially thought about using the variable
  `return_catch_flags', but it turned out that the variable also
  counts the levels of `evalstring' so I decided to use `funcnest +
  sourcenest' instead.  The patch is tested with the above four cases.

--
Koichi

------------------------------------------------------------------------


2020-04-19 5:12 Chet Ramey <address@hidden>:
> The POSIX wording seems straightforward and implies (B). The
> `action' is a string that is defined to behave as if it were the
> argument to `eval', so it can be an arbitrary command, which makes
> (A) unlikely.
>
> You could always ask the austin-group list for an interpretation, or
> send me something that I could forward to the list for you.

Thank you for the suggestion.  Is <austin-group-l@opengroup.org> the
mailing list you mentioned above?  I have created an account in
opengroup.org and subscribed to the mailing list.  I will later write
a question on wording of `return' special builtin in that list.

> That's an unreasonable statement, throwing out all uses of return without
> an argument because of how it behaves while running a trap.

OK.  I agree that for the shell functions that will not be used in
trap handlers, no-argument `return' can be used without problems.

Actually the situation in my script (ble.sh) is a little bit special.
In my script, some parts of Bash features are emulated.  I run `eval
-- "$PROMPT_COMMAND"' in SIGWINCH handler where `PROMPT_COMMAND' is
specified by users so is not under the control of the script but under
the control of the user.  Naively, with interpretation (B), I need to
put restrictions on the commands that can be specified in
`PROMPT_COMMAND', on which there are no restrictions in the original
Bash.  The use of no-argument `return' is common, and such
restrictions are non-trivial for users.  In fact, there are already
existing Bash configurations, that use no-argument `return' in
`PROMPT_COMMAND', which I would like to support with my script.  One
example is `bash-preexec' (https://github.com/rcaloras/bash-preexec)
which aims to provide a feature like `preexec' and `precmd' hooks of
zsh.  `bash-preexec' uses no-argument `return'.  The configuration
provided by iTerm2 for shell--terminal integration also uses this
`bash-preexec' framework.

I would appreciate it if you could provide me some suggestion on other
ways to work around the general problems caused by such user-provided
`PROMPT_COMMAND'?

2020-04-17 2:21 Koichi Murase <address@hidden>:

>   Also, I have checked the behavior of other shells. `zsh', `ash'
>   family (dash/ash, busybox sh) and `posh' does not implement the
>   special treatment of `return' in trap handlers.  `ksh' family
>   (ksh93, mksh) and `yash' implements the interpretation (B).  There
>   is no existing implementation of (A).  But currently I still think
>   the intepretation (A) is reasonable.  If there is rationale for
>   the interpretation (B), I would like to know it.

Let me correct this paragraph. Actually `zsh', `dash' and `busybox'
implement the behavior of the interpretation (A).  After my previous
email, I noticed that there was an oversight in testing the shells.
With the attached script `0015-test4.sh',

$ bash 0015-test4.sh
In trap-argument: last command preceding the trap action
In a function call: last command preceding the trap action
$ bash-4.3 0015-test4.sh
In trap-argument: last command in the trap action
In a function call: last command in the trap action
$ zsh 0015-test4.sh
In trap-argument: last command preceding the trap action
In a function call: last command in the trap action
$ dash 0015-test4.sh
In trap-argument: last command preceding the trap action
In a function call: last command in the trap action
$ busybox sh 0015-test4.sh
In trap-argument: last command preceding the trap action
In a function call: last command in the trap action
$ mksh 0015-test4.sh
In trap-argument: last command preceding the trap action
In a function call: last command preceding the trap action
$ ksh 0015-test4.sh
In trap-argument: last command preceding the trap action
In a function call: last command preceding the trap action
$ yash 0015-test4.sh
In trap-argument: (failed to exit the function)
In a function call: last command preceding the trap action
$ posh 0015-test4.sh
In trap-argument: last command in the trap action
In a function call: last command in the trap action

which can be summarized in the following list:

Interpretation A: zsh, dash, busybox
Interpretation B: bash-5.0, ksh, mksh
Interpretation B (broken): yash
Not implemeted: bash-4.3, posh

--
Koichi

------------------------------------------------------------------------


From: Koichi Murase <address@hidden>
To: austin-group-l@opengroup.org
Subject: XCU 2.14: Exit status by no-argument `return' in shell trap handlers

I have a question on the POSIX behavior of `return' shell builtin
without arguments when used in a shell `trap' action.  I initially
came to this question on investigating an infinite-loop issue reported
by Silvio Knizek at

  https://github.com/akinomyoga/ble.sh/issues/48 .

Then, I reported the issue in bug-bash mailing list where I was
introduced to the austing-group list by Chet.  This is the thread:

  https://lists.gnu.org/archive/html/bug-bash/2020-04/threads.html#00089


The corresponding section in POSIX is as follows:

> [XCU 2.14 Special Built-In Utilities - return - EXIT STATUS]
>
> The value of the special parameter '?' shall be set to n, an
> unsigned decimal integer, or to the exit status of the last command
> executed if n is not specified. If n is not an unsigned decimal
> integer, or is greater than 255, the results are unspecified. When
> return is executed in a trap action, the last command is considered
> to be the command that executed immediately preceding the trap
> action.

What does ``When return is executed in a trap action'' exactly mean?
There can be two interpretations: (A) `return's specified in the
argument string of `trap' builtin (or, more specifically, `return's
which terminate the trap action) are affected, or (B) all the
`return's in an entire runtime function-call tree in trap processing
are affected.  Literally, it reads like the interpretation (B), but it
seems unreasonable.

- If this exception of `return' in trap actions aims to provide a way
  to recover the value of $? before the trap handler is invoked, the
  behavior (A) is enough, and there is no need to affect every
  `return's in the function-call tree as in (B).

- If the behavior of no-argument `return's can be changed in functions
  as in (B), one cannot reliably use no-argument `return's in the
  functions that can be possibly be used in trap handlers.  Actually
  this caused the infinite loop I mentioned above in Bash 5.0 which
  implements the interpretation (B).  With interpretation (B), it
  seems hard to work around it properly.

- If the literal interpretation (B) is correct, what is the use case
  of this behavior, or what is the rationale for this behavior?


In fact the implementation in shells varies.  I have tested using the
following script:

  # 0015-test4.sh

  setexit() { return "$1"; }
  invoke() { kill -USR1 $$; return 222; }

  trap 'setexit 111; return' USR1
  invoke
  case $? in
  (0)   echo 'In trap argument: last command preceding the trap action' ;;
  (111) echo 'In trap argument: last command in the trap action' ;;
  (222) echo 'In trap argument: (failed to exit the function)' ;;
  (*)   echo 'In trap argument: (unexpected)' ;;
  esac

  stat=99
  handler() { setexit 111; return; }
  trap 'handler; stat=$?; return' USR1
  invoke
  case $stat in
  (0)   echo 'In function call: last command preceding the trap action' ;;
  (111) echo 'In function call: last command in the trap action' ;;
  (*)   echo 'In function call: (unexpected)' ;;
  esac

`zsh-5.7.1', `dash-0.5.10.2' and `busybox-1.28.3 implements the
interpretation (A) which produces the following result:

  In trap argument: last command preceding the trap action
  In function call: last command in the trap action

`bash-4.4', `ksh-2020.0.0' and `mksh R57' implements the
interpretation (B) which produces the following result:

  In trap argument: last command preceding the trap action
  In function call: last command preceding the trap action

`bash-4.3' and `posh-0.13.2' does not implement the special treatment
in a trap action.

  In trap argument: last command in the trap action
  In function call: last command in the trap action

`yash-2.49' seems to try to implement the interpretation (B), but it
behaves differently from other shells.

  In trap argument: (failed to exit the function)
  In function call: last command preceding the trap action

  It seems `yash' fails to follow the following description.

  > XCU 2.14 Special Built-In Utilities - trap - DESCRIPTION
  >
  > Each time trap is invoked, the action argument shall be processed
  > in a manner equivalent to:
  >
  > eval action

--
Koichi Murase

------------------------------------------------------------------------


2020-04-19 15:21 Oğuz <address@hidden>:
> The same document you linked says:
>
> > If the shell is not currently executing a function or dot script, the
> > results are unspecified.
>
> in DESCRIPTION section; it's unspecified what those returns do.

Thank you for the comment, but I am confused.  In both two examples
that I provided, it actually running a function when `kill' is called,
i.e. `kill' is called when `invoke' is executed.  Then the trap
handler is invoked while executing the function.

If that is not the correct interpretation [i.e., the function is not
considered currently executed while the trap handler is processed, and
the description on `return' applies only to `return's appearing in the
function calls inside the trap action], then it is the third
interpretation:

(C) The `return's in the function-call tree in trap processing are
  affected, but the behavior of `return' directly called from the trap
  argument is unspecified.

However, in this case, the same question for the interpretation (B)
also applies to the interpretation (C):

2020-04-19 13:32 Koichi Murase <address@hidden>:
> > - If the literal interpretation (B) is correct, what is the use case
> >   of this behavior, or what is the rationale for this behavior?

Currently, I do not see any rationale for the behavior (B) or (C).
Does anyone know something which explains the necessity of the
behavior (B) or (C)?

It seems to me that (A) is the natural behavior because it is more
consistent with the following description in `trap' section.  I can
imagine that the special case for the `return' exit status is added to
make it more consistent with this section.

https://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_28_03
> [XCU 2.14 Special Built-In Utilities - trap - DESCRIPTION/paragraph 2]
>
> [...] The value of "$?" after the trap action completes shall be the value
> it had before trap was invoked.

Maybe I am wrong, but I cannot stop suspecting that this is a wording
problem that the original intension is (A), but it just reads like (B)
or (C) due to not enough description in the standard.
